@inherits LayoutComponentBase
@using ClinicBookingSystem.Frontend.Services
@inject AuthService AuthService
@inject NavigationManager NavigationManager

<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main>
        <div class="top-row px-4 d-flex justify-content-between align-items-center" style="overflow: visible;">
            <a href="https://learn.microsoft.com/aspnet/core/" target="_blank">About</a>
            
            <div class="d-flex align-center gap-3" style="overflow: visible;">
                <!-- Notifications -->
                <MudMenu AnchorOrigin="Origin.BottomRight" 
                         TransformOrigin="Origin.TopRight"
                         Class="notification-menu">
                    <ActivatorContent>
                        <div style="position: relative; display: inline-block;">
                            <MudIconButton Icon="@Icons.Material.Outlined.Notifications" 
                                           Size="Size.Medium"
                                           Style="color: #666;" />
                            @if (notificationCount > 0)
                            {
                                <span style="position: absolute; top: 2px; right: 2px; min-width: 18px; height: 18px; 
                                             background: #f44336; color: white; border-radius: 50%; 
                                             font-size: 0.7rem; font-weight: 600; 
                                             display: flex; align-items: center; justify-content: center;
                                             box-shadow: 0 2px 4px rgba(244, 67, 54, 0.4);">
                                    @notificationCount
                                </span>
                            }
                        </div>
                    </ActivatorContent>
                    <ChildContent>
                        <div style="width: 320px; max-height: 400px; overflow: hidden;">
                            <div style="padding: 16px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                                <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Notifications</MudText>
                                @if (notificationCount > 0)
                                {
                                    <MudButton Size="Size.Small" 
                                               Variant="Variant.Text" 
                                               Color="Color.Primary"
                                               OnClick="MarkAllAsRead"
                                               Style="font-size: 0.75rem;">
                                        Mark all read
                                    </MudButton>
                                }
                            </div>
                            
                            <div style="max-height: 300px; overflow-y: auto;">
                                @if (notifications.Any())
                                {
                                    @foreach (var notification in notifications)
                                    {
                                        <div class="notification-item @(notification.IsRead ? "" : "unread")" 
                                             style="padding: 12px 16px; border-bottom: 1px solid #f5f5f5; cursor: pointer;"
                                             @onclick="() => MarkAsRead(notification)">
                                            <div class="d-flex gap-3">
                                                <MudAvatar Size="Size.Small" 
                                                           Style="@($"background: {GetNotificationColor(notification.Type)}20; color: {GetNotificationColor(notification.Type)};")">
                                                    <MudIcon Icon="@GetNotificationIcon(notification.Type)" Size="Size.Small" />
                                                </MudAvatar>
                                                <div style="flex: 1; min-width: 0;">
                                                    <MudText Style="@($"font-weight: {(notification.IsRead ? "400" : "600")}; font-size: 0.875rem; color: #333;")">
                                                        @notification.Title
                                                    </MudText>
                                                    <MudText Typo="Typo.caption" Style="color: #888; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                                        @notification.Message
                                                    </MudText>
                                                    <MudText Typo="Typo.caption" Style="color: #aaa; margin-top: 4px;">
                                                        @notification.TimeAgo
                                                    </MudText>
                                                </div>
                                                @if (!notification.IsRead)
                                                {
                                                    <div style="width: 8px; height: 8px; background: #667eea; border-radius: 50%; margin-top: 6px;"></div>
                                                }
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div style="padding: 32px 16px; text-align: center;">
                                        <MudIcon Icon="@Icons.Material.Outlined.NotificationsNone" 
                                                 Style="font-size: 3rem; color: #e0e0e0;" />
                                        <MudText Style="color: #999; margin-top: 8px;">No notifications</MudText>
                                    </div>
                                }
                            </div>
                            
                            @if (notifications.Any())
                            {
                                <div style="padding: 12px; border-top: 1px solid #f0f0f0; text-align: center;">
                                    <MudButton Size="Size.Small" 
                                               Variant="Variant.Text" 
                                               Color="Color.Primary"
                                               FullWidth="true">
                                        View All Notifications
                                    </MudButton>
                                </div>
                            }
                        </div>
                    </ChildContent>
                </MudMenu>

                <!-- User Menu -->
                <MudMenu AnchorOrigin="Origin.BottomRight" 
                         TransformOrigin="Origin.TopRight"
                         Dense="true"
                         Class="user-menu">
                <ActivatorContent>
                    <MudButton Variant="Variant.Text" 
                               EndIcon="@Icons.Material.Filled.KeyboardArrowDown"
                               Class="user-menu-button"
                               Style="text-transform: none; border-radius: 12px; padding: 6px 12px;">
                        <MudAvatar Size="Size.Small" 
                                   Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600; font-size: 0.85rem;">
                            @(AuthService.CurrentUser?.FirstName?.Substring(0, 1).ToUpper() ?? "U")
                        </MudAvatar>
                        <div class="d-flex flex-column align-start ml-2" style="line-height: 1.2;">
                            <span style="font-weight: 600; font-size: 0.9rem; color: #333;">@(AuthService.CurrentUser?.FirstName ?? "User")</span>
                            <span style="font-size: 0.7rem; color: #888;">Patient</span>
                        </div>
                    </MudButton>
                </ActivatorContent>
                <ChildContent>
                    <div style="padding: 12px 16px; border-bottom: 1px solid #f0f0f0; background: linear-gradient(135deg, #667eea08 0%, #764ba208 100%);">
                        <div class="d-flex align-center gap-3">
                            <MudAvatar Size="Size.Medium" 
                                       Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600;">
                                @(AuthService.CurrentUser?.FirstName?.Substring(0, 1).ToUpper() ?? "U")@(AuthService.CurrentUser?.LastName?.Substring(0, 1).ToUpper() ?? "")
                            </MudAvatar>
                            <div>
                                <MudText Typo="Typo.subtitle2" Style="font-weight: 600; color: #333;">
                                    @(AuthService.CurrentUser?.FirstName ?? "User") @(AuthService.CurrentUser?.LastName ?? "")
                                </MudText>
                                <MudText Typo="Typo.caption" Style="color: #888;">
                                    @(AuthService.CurrentUser?.Email ?? "user@email.com")
                                </MudText>
                            </div>
                        </div>
                    </div>
                    
                    <div style="padding: 8px 0;">
                        <MudMenuItem OnClick="GoToProfile" Style="padding: 10px 16px;">
                            <div class="d-flex align-center gap-3">
                                <MudIcon Icon="@Icons.Material.Outlined.Person" Size="Size.Small" Style="color: #667eea;" />
                                <div>
                                    <MudText Style="font-weight: 500; font-size: 0.875rem;">My Profile</MudText>
                                    <MudText Typo="Typo.caption" Style="color: #888;">View and edit your profile</MudText>
                                </div>
                            </div>
                        </MudMenuItem>
                        
                        <MudMenuItem OnClick="GoToSettings" Style="padding: 10px 16px;">
                            <div class="d-flex align-center gap-3">
                                <MudIcon Icon="@Icons.Material.Outlined.Settings" Size="Size.Small" Style="color: #667eea;" />
                                <div>
                                    <MudText Style="font-weight: 500; font-size: 0.875rem;">Settings</MudText>
                                    <MudText Typo="Typo.caption" Style="color: #888;">Account preferences</MudText>
                                </div>
                            </div>
                        </MudMenuItem>
                        
                        <MudMenuItem OnClick="@(() => NavigationManager.NavigateTo("/"))" Style="padding: 10px 16px;">
                            <div class="d-flex align-center gap-3">
                                <MudIcon Icon="@Icons.Material.Outlined.CalendarMonth" Size="Size.Small" Style="color: #667eea;" />
                                <div>
                                    <MudText Style="font-weight: 500; font-size: 0.875rem;">My Appointments</MudText>
                                    <MudText Typo="Typo.caption" Style="color: #888;">View upcoming visits</MudText>
                                </div>
                            </div>
                        </MudMenuItem>
                    </div>
                    
                    <MudDivider />
                    
                    <div style="padding: 8px 0;">
                        <MudMenuItem OnClick="HandleLogout" Style="padding: 10px 16px;">
                            <div class="d-flex align-center gap-3">
                                <MudIcon Icon="@Icons.Material.Outlined.Logout" Size="Size.Small" Style="color: #e53935;" />
                                <MudText Style="font-weight: 500; font-size: 0.875rem; color: #e53935;">Sign Out</MudText>
                            </div>
                        </MudMenuItem>
                    </div>
                </ChildContent>
            </MudMenu>
            </div>
        </div>

        <article class="content px-4">
            @Body
        </article>
    </main>
</div>

<style>
    .user-menu .mud-popover,
    .notification-menu .mud-popover {
        border-radius: 16px !important;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12) !important;
        border: 1px solid #f0f0f0 !important;
        overflow: hidden !important;
    }
    
    .user-menu .mud-popover {
        min-width: 280px !important;
    }
    
    .user-menu-button:hover {
        background: rgba(102, 126, 234, 0.08) !important;
    }
    
    .mud-menu-item:hover {
        background: rgba(102, 126, 234, 0.06) !important;
    }
    
    .notification-item:hover {
        background: rgba(102, 126, 234, 0.04) !important;
    }
    
    .notification-item.unread {
        background: rgba(102, 126, 234, 0.03);
    }
    
    .notification-badge {
        overflow: visible !important;
    }
    
    .notification-badge .mud-badge-content {
        font-size: 0.65rem !important;
        min-width: 18px !important;
        height: 18px !important;
        top: -4px !important;
        right: -4px !important;
    }
    
    .notification-menu {
        overflow: visible !important;
    }
    
    .notification-menu > button,
    .notification-menu > div {
        overflow: visible !important;
    }
    
    .top-row {
        overflow: visible !important;
    }
    
    .top-row * {
        overflow: visible;
    }
    
    .mud-badge-root {
        overflow: visible !important;
    }
    
    .mud-badge {
        overflow: visible !important;
    }
</style>

@code {
    private int notificationCount => notifications.Count(n => !n.IsRead);
    
    private List<NotificationItem> notifications = new()
    {
        new NotificationItem
        {
            Id = 1,
            Title = "Appointment Reminder",
            Message = "Your appointment with Dr. Smith is tomorrow at 10:00 AM.",
            Type = NotificationType.Reminder,
            CreatedAt = DateTime.Now.AddHours(-2),
            IsRead = false
        },
        new NotificationItem
        {
            Id = 2,
            Title = "Appointment Confirmed",
            Message = "Your appointment has been confirmed for December 20, 2025.",
            Type = NotificationType.Success,
            CreatedAt = DateTime.Now.AddDays(-1),
            IsRead = false
        },
        new NotificationItem
        {
            Id = 3,
            Title = "Welcome to Clinic Booking!",
            Message = "Thank you for registering. Start by booking your first appointment.",
            Type = NotificationType.Info,
            CreatedAt = DateTime.Now.AddDays(-3),
            IsRead = true
        }
    };

    private void HandleLogout()
    {
        AuthService.Logout();
    }

    private void GoToProfile()
    {
        NavigationManager.NavigateTo("/profile");
    }

    private void GoToSettings()
    {
        NavigationManager.NavigateTo("/profile");
    }
    
    private void MarkAsRead(NotificationItem notification)
    {
        notification.IsRead = true;
        StateHasChanged();
    }
    
    private void MarkAllAsRead()
    {
        foreach (var notification in notifications)
        {
            notification.IsRead = true;
        }
        StateHasChanged();
    }
    
    private string GetNotificationIcon(NotificationType type) => type switch
    {
        NotificationType.Reminder => Icons.Material.Outlined.AccessTime,
        NotificationType.Success => Icons.Material.Outlined.CheckCircle,
        NotificationType.Warning => Icons.Material.Outlined.Warning,
        NotificationType.Error => Icons.Material.Outlined.Error,
        _ => Icons.Material.Outlined.Info
    };
    
    private string GetNotificationColor(NotificationType type) => type switch
    {
        NotificationType.Reminder => "#667eea",
        NotificationType.Success => "#4caf50",
        NotificationType.Warning => "#ff9800",
        NotificationType.Error => "#f44336",
        _ => "#2196f3"
    };
    
    public class NotificationItem
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string Message { get; set; } = string.Empty;
        public NotificationType Type { get; set; }
        public DateTime CreatedAt { get; set; }
        public bool IsRead { get; set; }
        
        public string TimeAgo
        {
            get
            {
                var diff = DateTime.Now - CreatedAt;
                if (diff.TotalMinutes < 1) return "Just now";
                if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m ago";
                if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}h ago";
                if (diff.TotalDays < 7) return $"{(int)diff.TotalDays}d ago";
                return CreatedAt.ToString("MMM dd");
            }
        }
    }
    
    public enum NotificationType
    {
        Info,
        Success,
        Warning,
        Error,
        Reminder
    }
}
