@page "/"
@page "/home"
@using ClinicBookingSystem.Frontend.Services
@using ClinicBookingSystem.Frontend.Models
@using ClinicBookingSystem.Frontend.Components
@inject AuthService AuthService
@inject BookingService BookingService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject IDialogService DialogService

<PageTitle>Dashboard - Clinic Booking System</PageTitle>

@if (hasError)
{
    <!-- Error Boundary UI -->
    <MudContainer MaxWidth="MaxWidth.Medium" Class="py-8">
        <MudPaper Elevation="0" Class="pa-8 rounded-lg text-center" Style="border: 2px dashed #f44336; background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);">
            <MudIcon Icon="@Icons.Material.Filled.ErrorOutline" 
                     Style="font-size: 5rem; color: #f44336; opacity: 0.8;" />
            
            <MudText Typo="Typo.h5" Class="mt-4" Style="color: #c62828; font-weight: 600;">
                Oops! Something went wrong
            </MudText>
            
            <MudText Typo="Typo.body1" Class="mt-2" Style="color: #666; max-width: 500px; margin: 0 auto;">
                @errorMessage
            </MudText>
            
            @if (!string.IsNullOrEmpty(errorDetails))
            {
                <MudExpansionPanels Class="mt-4" Style="max-width: 600px; margin: 0 auto;">
                    <MudExpansionPanel Text="Technical Details" Style="background: rgba(255,255,255,0.7);">
                        <MudText Typo="Typo.caption" Style="color: #888; font-family: monospace; text-align: left; word-break: break-all;">
                            @errorDetails
                        </MudText>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            }
            
            <div class="d-flex justify-center gap-3 mt-6">
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Refresh"
                           OnClick="RetryLoading"
                           Disabled="@isRetrying"
                           Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    @if (isRetrying)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" Style="color: white;" />
                        <span>Retrying...</span>
                    }
                    else
                    {
                        <span>Try Again</span>
                    }
                </MudButton>
                
                <MudButton Variant="Variant.Outlined" 
                           Color="Color.Default"
                           StartIcon="@Icons.Material.Filled.Home"
                           OnClick="@(() => NavigationManager.NavigateTo("/", true))">
                    Refresh Page
                </MudButton>
            </div>
            
            <MudText Typo="Typo.caption" Class="mt-4" Style="color: #888;">
                If the problem persists, please contact support or try again later.
            </MudText>
        </MudPaper>
        
        <!-- Helpful Tips -->
        <MudPaper Elevation="0" Class="pa-4 mt-4 rounded-lg" Style="border: 1px solid #e0e0e0; background: #fafafa;">
            <div class="d-flex align-center gap-2 mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Lightbulb" Style="color: #ffc107;" />
                <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">Troubleshooting Tips</MudText>
            </div>
            <MudList T="string" Dense="true">
                <MudListItem Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success" IconSize="Size.Small">
                    <MudText Typo="Typo.body2">Check your internet connection</MudText>
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success" IconSize="Size.Small">
                    <MudText Typo="Typo.body2">Make sure the backend server is running</MudText>
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success" IconSize="Size.Small">
                    <MudText Typo="Typo.body2">Clear browser cache and cookies</MudText>
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success" IconSize="Size.Small">
                    <MudText Typo="Typo.body2">Try logging out and logging back in</MudText>
                </MudListItem>
            </MudList>
        </MudPaper>
    </MudContainer>
}
else
{
<!-- Hero Section -->
<div class="hero-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2rem 0; margin-bottom: 2rem;">
    <MudContainer MaxWidth="MaxWidth.Large">
        <div class="d-flex justify-space-between align-center flex-wrap gap-4">
            <div>
                <MudText Typo="Typo.h4" Style="color: white; font-weight: 600;">
                    Welcome back, @(AuthService.CurrentUser?.FirstName ?? "Guest")! 👋
                </MudText>
                <MudText Typo="Typo.body1" Style="color: rgba(255,255,255,0.85); margin-top: 0.5rem;">
                    Manage your appointments and health records in one place
                </MudText>
            </div>
            <div class="d-flex gap-3">
                <MudButton Variant="Variant.Filled" 
                           Style="background-color: white; color: #667eea;"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="StartNewAppointment">
                    New Appointment
                </MudButton>
                <MudButton Variant="Variant.Outlined" 
                           Style="border-color: white; color: white;"
                           StartIcon="@Icons.Material.Filled.Person"
                           Href="/profile">
                    My Profile
                </MudButton>
            </div>
        </div>
    </MudContainer>
</div>

<MudContainer MaxWidth="MaxWidth.Large" Class="pb-8">
    <!-- Quick Stats -->
    <MudGrid Class="mb-6">
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="0" Class="pa-4 rounded-lg stat-card" Style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                <div class="d-flex align-center justify-space-between">
                    <div>
                        <MudText Typo="Typo.h4" Style="color: white; font-weight: 700;" Class="counter-number">@animatedUpcoming</MudText>
                        <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.9);">Upcoming</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.EventAvailable" Style="color: rgba(255,255,255,0.3); font-size: 3rem;" Class="stat-icon" />
                </div>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="0" Class="pa-4 rounded-lg stat-card" Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="d-flex align-center justify-space-between">
                    <div>
                        <MudText Typo="Typo.h4" Style="color: white; font-weight: 700;" Class="counter-number">@animatedCompleted</MudText>
                        <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.9);">Completed</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Style="color: rgba(255,255,255,0.3); font-size: 3rem;" Class="stat-icon" />
                </div>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="0" Class="pa-4 rounded-lg stat-card" Style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="d-flex align-center justify-space-between">
                    <div>
                        <MudText Typo="Typo.h4" Style="color: white; font-weight: 700;" Class="counter-number">@animatedDoctors</MudText>
                        <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.9);">Doctors</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.LocalHospital" Style="color: rgba(255,255,255,0.3); font-size: 3rem;" Class="stat-icon" />
                </div>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="0" Class="pa-4 rounded-lg stat-card" Style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="d-flex align-center justify-space-between">
                    <div>
                        <MudText Typo="Typo.h4" Style="color: white; font-weight: 700;" Class="counter-number">@animatedTotalVisits</MudText>
                        <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.9);">Total Visits</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.Assessment" Style="color: rgba(255,255,255,0.3); font-size: 3rem;" Class="stat-icon" />
                </div>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <style>
        .stat-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .stat-icon {
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover .stat-icon {
            transform: scale(1.1);
        }
        
        .counter-number {
            transition: transform 0.2s ease;
        }
        
        @@keyframes countPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .counting {
            animation: countPulse 0.1s ease;
        }
    </style>

    <!-- Patient Search Card -->
    <MudPaper Elevation="0" Class="rounded-lg overflow-hidden mb-4" Style="border: 1px solid #e0e0e0;">
        <div class="pa-4" style="background: #fafafa; border-bottom: 1px solid #e0e0e0;">
            <div class="d-flex align-center gap-2">
                <MudIcon Icon="@Icons.Material.Filled.PersonSearch" Color="Color.Primary" />
                <MudText Typo="Typo.h6" Style="font-weight: 600;">Search Patients</MudText>
            </div>
        </div>
        
        <div class="pa-4 pa-md-6">
            <MudGrid Spacing="3" Class="align-center">
                <MudItem xs="12" sm="8" md="6">
                    <MudTextField @bind-Value="patientSearchText" 
                                  Placeholder="Search by name or email..."
                                  Variant="Variant.Outlined"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  Immediate="true"
                                  OnKeyDown="OnPatientSearchKeyDown"
                                  Style="background: white;" />
                </MudItem>
                <MudItem xs="12" sm="4" md="2">
                    <MudButton Variant="Variant.Filled" 
                               OnClick="SearchPatients"
                               Disabled="@(isSearchingPatients || string.IsNullOrWhiteSpace(patientSearchText))"
                               FullWidth="true"
                               Style="height: 56px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        @if (isSearchingPatients)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" Style="color: white;" />
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Search" Class="mr-1" />
                        }
                        Search
                    </MudButton>
                </MudItem>
            </MudGrid>

            @if (searchedPatients.Any())
            {
                <MudTable Items="@searchedPatients" Hover="true" Dense="true" Class="mt-4" Elevation="0" Style="border: 1px solid #e0e0e0; border-radius: 8px;">
                    <HeaderContent>
                        <MudTh Style="background: #fafafa; font-weight: 600;">Name</MudTh>
                        <MudTh Style="background: #fafafa; font-weight: 600;">Email</MudTh>
                        <MudTh Style="background: #fafafa; font-weight: 600;">Phone</MudTh>
                        <MudTh Style="background: #fafafa; font-weight: 600;">Registered</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Name">
                            <div class="d-flex align-center gap-2">
                                <MudAvatar Size="Size.Small" Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 0.75rem;">
                                    @context.FirstName[0]@context.LastName[0]
                                </MudAvatar>
                                <MudText Style="font-weight: 500;">@context.FullName</MudText>
                            </div>
                        </MudTd>
                        <MudTd DataLabel="Email">@context.Email</MudTd>
                        <MudTd DataLabel="Phone">@(context.PhoneNumber ?? "—")</MudTd>
                        <MudTd DataLabel="Registered">@context.CreatedAt.ToString("MMM dd, yyyy")</MudTd>
                    </RowTemplate>
                </MudTable>
            }
            else if (hasSearchedPatients && !searchedPatients.Any())
            {
                <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="mt-4">
                    No patients found matching "@patientSearchText"
                </MudAlert>
            }
        </div>
    </MudPaper>

    <MudGrid Spacing="4">
        <!-- Book Appointment Card -->
        <MudItem xs="12" lg="8">
            <MudPaper id="booking-card" Elevation="0" Class="rounded-lg overflow-hidden" Style="border: 1px solid #e0e0e0;">
                <div class="pa-4" style="background: #fafafa; border-bottom: 1px solid #e0e0e0;">
                    <div class="d-flex align-center gap-2">
                        <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Color="Color.Primary" />
                        <MudText Typo="Typo.h6" Style="font-weight: 600;">Book an Appointment</MudText>
                    </div>
                </div>
                
                <div class="pa-4 pa-md-6">
                    <!-- Progress Steps -->
                    <div class="d-flex justify-center mb-6">
                        <MudStack Row="true" Spacing="0" AlignItems="AlignItems.Center">
                            @for (int i = 0; i < 3; i++)
                            {
                                var stepIndex = i;
                                var stepNames = new[] { "Doctor", "Schedule", "Confirm" };
                                var stepIcons = new[] { Icons.Material.Filled.Person, Icons.Material.Filled.Schedule, Icons.Material.Filled.CheckCircle };
                                
                                <div class="d-flex flex-column align-center" style="min-width: 80px;">
                                    <MudAvatar Size="Size.Medium" 
                                               Style="@($"background: {(activeStep >= stepIndex ? "linear-gradient(135deg, #667eea 0%, #764ba2 100%)" : "#e0e0e0")}; color: white;")">
                                        @if (activeStep > stepIndex)
                                        {
                                            <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" />
                                        }
                                        else
                                        {
                                            <MudIcon Icon="@stepIcons[stepIndex]" Size="Size.Small" />
                                        }
                                    </MudAvatar>
                                    <MudText Typo="Typo.caption" Class="mt-1" Style="@($"color: {(activeStep >= stepIndex ? "#667eea" : "#9e9e9e")}; font-weight: {(activeStep == stepIndex ? "600" : "400")};")">
                                        @stepNames[stepIndex]
                                    </MudText>
                                </div>
                                @if (i < 2)
                                {
                                    <div style="@($"width: 60px; height: 2px; background: {(activeStep > stepIndex ? "#667eea" : "#e0e0e0")}; margin: 0 0.5rem; margin-bottom: 1.5rem;")"></div>
                                }
                            }
                        </MudStack>
                    </div>

                    <!-- Step 1: Select Doctor -->
                    @if (activeStep == 0)
                    {
                        <div class="d-flex gap-3 mb-4 flex-wrap">
                            <MudTextField @bind-Value="doctorSearchText" 
                                          Placeholder="Search doctors by name or specialization..."
                                          Variant="Variant.Outlined"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Search"
                                          Immediate="true"
                                          Style="flex: 1; min-width: 250px;" />
                            <MudButton Variant="Variant.Filled"
                                       StartIcon="@Icons.Material.Filled.PersonAdd"
                                       OnClick="OpenAddDoctorDialog"
                                       Style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); height: 56px;">
                                Add Doctor
                            </MudButton>
                        </div>
                        
                        @if (isLoadingDoctors)
                        {
                            <div class="d-flex justify-center pa-8">
                                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                            </div>
                        }
                        else
                        {
                            <MudGrid Spacing="3">
                                @foreach (var doctor in FilteredDoctors)
                                {
                                    var isSelected = selectedDoctor?.Id == doctor.Id;
                                    <MudItem xs="12" sm="6">
                                        <MudPaper Elevation="0" 
                                                  Class="pa-4 rounded-lg cursor-pointer transition-all"
                                                  Style="@($"border: 2px solid {(isSelected ? "#667eea" : "#e0e0e0")}; background: {(isSelected ? "#f5f3ff" : "white")}; transition: all 0.2s ease;")"
                                                  @onclick="() => SelectDoctor(doctor)">
                                            <div class="d-flex align-center gap-3">
                                                <MudAvatar Size="Size.Large" Style="@($"background: {(isSelected ? "linear-gradient(135deg, #667eea 0%, #764ba2 100%)" : "#e8eaf6")}; color: {(isSelected ? "white" : "#667eea")};")">
                                                    <MudIcon Icon="@Icons.Material.Filled.Person" />
                                                </MudAvatar>
                                                <div class="flex-grow-1">
                                                    <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">@doctor.FullName</MudText>
                                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="Color.Primary" Class="ma-0 pa-0">
                                                        @doctor.Specialization
                                                    </MudChip>
                                                </div>
                                                @if (isSelected)
                                                {
                                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Primary" />
                                                }
                                            </div>
                                        </MudPaper>
                                    </MudItem>
                                }
                                @if (!FilteredDoctors.Any() && !string.IsNullOrWhiteSpace(doctorSearchText))
                                {
                                    <MudItem xs="12">
                                        <MudAlert Severity="Severity.Info" Variant="Variant.Text">
                                            No doctors found matching "@doctorSearchText"
                                        </MudAlert>
                                    </MudItem>
                                }
                            </MudGrid>
                        }
                    }

                    <!-- Step 2: Select Date & Time -->
                    @if (activeStep == 1)
                    {
                        <MudGrid Spacing="4">
                            <MudItem xs="12" md="6">
                                <MudText Typo="Typo.subtitle2" Class="mb-2" Style="font-weight: 600; color: #424242;">
                                    <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Class="mr-1" />
                                    Select Date
                                </MudText>
                                <MudDatePicker @bind-Date="selectedDate" 
                                               Placeholder="Choose appointment date"
                                               MinDate="DateTime.Today"
                                               MaxDate="DateTime.Today.AddMonths(2)"
                                               Variant="Variant.Outlined"
                                               DateFormat="dddd, MMM dd, yyyy"
                                               Style="background: white;" />
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudText Typo="Typo.subtitle2" Class="mb-2" Style="font-weight: 600; color: #424242;">
                                    <MudIcon Icon="@Icons.Material.Filled.AccessTime" Size="Size.Small" Class="mr-1" />
                                    Available Times
                                </MudText>
                                @if (isLoadingTimeSlots)
                                {
                                    <div class="d-flex justify-center pa-4">
                                        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Small" />
                                    </div>
                                }
                                else if (!selectedDate.HasValue)
                                {
                                    <MudAlert Severity="Severity.Info" Variant="Variant.Text" Dense="true">
                                        Please select a date first
                                    </MudAlert>
                                }
                                else if (timeSlots.Count == 0)
                                {
                                    <MudAlert Severity="Severity.Warning" Variant="Variant.Text" Dense="true">
                                        No available slots for this date
                                    </MudAlert>
                                }
                                else
                                {
                                    <div class="d-flex flex-wrap gap-2">
                                        @foreach (var slot in timeSlots)
                                        {
                                            var isSlotSelected = selectedTimeSlot?.Id == slot.Id;
                                            <MudButton Variant="@(isSlotSelected ? Variant.Filled : Variant.Outlined)"
                                                       Color="@(isSlotSelected ? Color.Primary : Color.Default)"
                                                       Size="Size.Small"
                                                       OnClick="() => SelectTimeSlot(slot)"
                                                       Style="@($"min-width: 90px; {(isSlotSelected ? "background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" : "")}")">
                                                @slot.DisplayTime
                                            </MudButton>
                                        }
                                    </div>
                                }
                            </MudItem>
                        </MudGrid>
                    }

                    <!-- Step 3: Confirm -->
                    @if (activeStep == 2)
                    {
                        <MudGrid Spacing="4">
                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="appointmentReason"
                                              Label="Reason for Visit"
                                              Variant="Variant.Outlined"
                                              Lines="3"
                                              Placeholder="Describe your symptoms or reason..."
                                              Style="background: white;" />
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="appointmentNotes"
                                              Label="Additional Notes (Optional)"
                                              Variant="Variant.Outlined"
                                              Lines="3"
                                              Placeholder="Any additional information..."
                                              Style="background: white;" />
                            </MudItem>
                            <MudItem xs="12">
                                <MudPaper Elevation="0" Class="pa-4 rounded-lg" Style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border: 1px solid #667eea30;">
                                    <MudText Typo="Typo.subtitle1" Class="mb-3" Style="font-weight: 600; color: #667eea;">
                                        <MudIcon Icon="@Icons.Material.Filled.Summarize" Size="Size.Small" Class="mr-1" />
                                        Appointment Summary
                                    </MudText>
                                    <MudGrid>
                                        <MudItem xs="12" sm="4">
                                            <MudText Typo="Typo.caption" Style="color: #666;">Doctor</MudText>
                                            <MudText Typo="Typo.body1" Style="font-weight: 500;">@(selectedDoctor?.FullName ?? "-")</MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Primary">@(selectedDoctor?.Specialization ?? "")</MudText>
                                        </MudItem>
                                        <MudItem xs="12" sm="4">
                                            <MudText Typo="Typo.caption" Style="color: #666;">Date & Time</MudText>
                                            <MudText Typo="Typo.body1" Style="font-weight: 500;">
                                                @(selectedDate.HasValue ? selectedDate.Value.ToString("MMM dd, yyyy") : "-")
                                            </MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Primary">@(selectedTimeSlot?.DisplayTime ?? "")</MudText>
                                        </MudItem>
                                        <MudItem xs="12" sm="4">
                                            <MudText Typo="Typo.caption" Style="color: #666;">Duration</MudText>
                                            <MudText Typo="Typo.body1" Style="font-weight: 500;">30 minutes</MudText>
                                        </MudItem>
                                    </MudGrid>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>
                    }

                    <!-- Navigation Buttons -->
                    <div class="d-flex justify-space-between mt-6 pt-4" style="border-top: 1px solid #e0e0e0;">
                        <MudButton Variant="Variant.Text" 
                                   Color="Color.Default" 
                                   OnClick="PreviousStep"
                                   Disabled="@(activeStep == 0)"
                                   StartIcon="@Icons.Material.Filled.ArrowBack">
                            Back
                        </MudButton>
                        
                        @if (activeStep < 2)
                        {
                            <MudButton Variant="Variant.Filled" 
                                       OnClick="NextStep"
                                       Disabled="@(!CanProceedToNextStep())"
                                       EndIcon="@Icons.Material.Filled.ArrowForward"
                                       Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                Continue
                            </MudButton>
                        }
                        else
                        {
                            <MudButton Variant="Variant.Filled" 
                                       OnClick="BookAppointment"
                                       Disabled="@(isBooking || !CanBookAppointment())"
                                       StartIcon="@(isBooking ? null : Icons.Material.Filled.CheckCircle)"
                                       Style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                                @if (isBooking)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" Style="color: white;" />
                                    <span>Booking...</span>
                                }
                                else
                                {
                                    <span>Confirm Booking</span>
                                }
                            </MudButton>
                        }
                    </div>
                </div>
            </MudPaper>
        </MudItem>

        <!-- My Appointments Card -->
        <MudItem xs="12" lg="4">
            <MudPaper Elevation="0" Class="rounded-lg overflow-hidden" Style="border: 1px solid #e0e0e0; height: 100%;">
                <div class="pa-4" style="background: #fafafa; border-bottom: 1px solid #e0e0e0;">
                    <div class="d-flex align-center justify-space-between">
                        <div class="d-flex align-center gap-2">
                            <MudIcon Icon="@Icons.Material.Filled.EventNote" Color="Color.Primary" />
                            <MudText Typo="Typo.h6" Style="font-weight: 600;">My Appointments</MudText>
                        </div>
                        <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Text">
                            @myAppointments.Count
                        </MudChip>
                    </div>
                </div>
                
                <div style="min-height: 400px; display: flex; flex-direction: column;">
                    @if (myAppointments.Count == 0)
                    {
                        <div class="pa-6 text-center flex-grow-1 d-flex flex-column justify-center">
                            <MudIcon Icon="@Icons.Material.Filled.EventBusy" Style="font-size: 4rem; color: #e0e0e0;" />
                            <MudText Typo="Typo.body1" Class="mt-2" Style="color: #9e9e9e;">No appointments yet</MudText>
                            <MudText Typo="Typo.caption" Style="color: #bdbdbd;">Book your first appointment above</MudText>
                        </div>
                    }
                    else
                    {
                        <div style="flex: 1;">
                            @foreach (var appointment in PaginatedAppointments)
                            {
                                <div class="pa-4" style="border-bottom: 1px solid #f0f0f0;">
                                    <div class="d-flex justify-space-between align-start mb-2">
                                        <div class="d-flex align-center gap-2">
                                            <MudAvatar Size="Size.Small" Style="background: #e8eaf6; color: #667eea;">
                                                <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                                            </MudAvatar>
                                            <div>
                                                <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">@appointment.DoctorName</MudText>
                                                <MudText Typo="Typo.caption" Style="color: #9e9e9e;">@appointment.DoctorSpecialization</MudText>
                                            </div>
                                        </div>
                                        <MudChip T="string" Size="Size.Small" Color="@appointment.StatusColor" Variant="Variant.Filled" Style="font-size: 0.7rem;">
                                            @appointment.StatusDisplay
                                        </MudChip>
                                    </div>
                                    <div class="d-flex align-center gap-2 ml-10">
                                        <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" Style="color: #9e9e9e;" />
                                        <MudText Typo="Typo.body2" Style="color: #666;">@appointment.DisplayDateTime</MudText>
                                    </div>
                                    @if (appointment.Status == AppointmentStatus.Scheduled || appointment.Status == AppointmentStatus.Confirmed)
                                    {
                                        <div class="mt-2 ml-10 d-flex gap-2">
                                            <MudButton Size="Size.Small" 
                                                       Variant="Variant.Text" 
                                                       Color="Color.Success"
                                                       StartIcon="@Icons.Material.Filled.CheckCircle"
                                                       OnClick="() => CompleteAppointment(appointment.Id)">
                                                Complete
                                            </MudButton>
                                            <MudButton Size="Size.Small" 
                                                       Variant="Variant.Text" 
                                                       Color="Color.Error"
                                                       StartIcon="@Icons.Material.Filled.Cancel"
                                                       OnClick="() => CancelAppointment(appointment.Id)">
                                                Cancel
                                            </MudButton>
                                        </div>
                                    }
                                    @if (appointment.Status == AppointmentStatus.Cancelled && appointment.AppointmentDate.Date >= DateTime.Today)
                                    {
                                        <div class="mt-2 ml-10">
                                            <MudButton Size="Size.Small" 
                                                       Variant="Variant.Text" 
                                                       Color="Color.Success"
                                                       StartIcon="@Icons.Material.Filled.Restore"
                                                       OnClick="() => RestoreAppointment(appointment.Id)">
                                                Restore
                                            </MudButton>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                        
                        @if (TotalAppointmentPages > 1)
                        {
                            <div class="pa-3" style="border-top: 1px solid #e0e0e0; background: #fafafa;">
                                <div class="d-flex justify-center align-center gap-2">
                                    <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft" 
                                                   Size="Size.Small"
                                                   Disabled="@(appointmentCurrentPage == 1)"
                                                   OnClick="PreviousAppointmentPage"
                                                   Style="@(appointmentCurrentPage == 1 ? "color: #ccc;" : "color: #667eea;")" />
                                    
                                    @for (int i = 1; i <= TotalAppointmentPages; i++)
                                    {
                                        var pageNum = i;
                                        <MudButton Size="Size.Small"
                                                   Variant="@(appointmentCurrentPage == pageNum ? Variant.Filled : Variant.Text)"
                                                   OnClick="() => GoToAppointmentPage(pageNum)"
                                                   Style="@(appointmentCurrentPage == pageNum ? "background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-width: 32px; padding: 4px 8px;" : "min-width: 32px; padding: 4px 8px; color: #666;")">
                                            @pageNum
                                        </MudButton>
                                    }
                                    
                                    <MudIconButton Icon="@Icons.Material.Filled.ChevronRight" 
                                                   Size="Size.Small"
                                                   Disabled="@(appointmentCurrentPage == TotalAppointmentPages)"
                                                   OnClick="NextAppointmentPage"
                                                   Style="@(appointmentCurrentPage == TotalAppointmentPages ? "color: #ccc;" : "color: #667eea;")" />
                                </div>
                                <MudText Typo="Typo.caption" Align="Align.Center" Style="color: #888; margin-top: 4px;">
                                    Showing @(((appointmentCurrentPage - 1) * appointmentsPerPage) + 1)-@Math.Min(appointmentCurrentPage * appointmentsPerPage, myAppointments.Count) of @myAppointments.Count
                                </MudText>
                            </div>
                        }
                    }
                </div>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>
}

@code {
    private int activeStep = 0;
    private bool isLoadingDoctors = true;
    private bool isLoadingTimeSlots = false;
    private bool isBooking = false;
    private bool isSearchingPatients = false;
    private bool hasSearchedPatients = false;
    
    // Error handling states
    private bool hasError = false;
    private bool isRetrying = false;
    private string errorMessage = string.Empty;
    private string errorDetails = string.Empty;
    
    // Animated counter states
    private int animatedUpcoming = 0;
    private int animatedCompleted = 0;
    private int animatedDoctors = 0;
    private int animatedTotalVisits = 0;
    private bool hasAnimated = false;

    // Pagination for appointments
    private int appointmentCurrentPage = 1;
    private int appointmentsPerPage = 4;
    private int TotalAppointmentPages => (int)Math.Ceiling((double)myAppointments.Count / appointmentsPerPage);
    private IEnumerable<AppointmentModel> PaginatedAppointments => myAppointments
        .Skip((appointmentCurrentPage - 1) * appointmentsPerPage)
        .Take(appointmentsPerPage);

    private List<DoctorModel> doctors = new();
    private List<TimeSlotModel> timeSlots = new();
    private List<AppointmentModel> myAppointments = new();
    private List<PatientSearchResult> searchedPatients = new();

    private DoctorModel? selectedDoctor;
    private string doctorSearchText = string.Empty;
    private string patientSearchText = string.Empty;

    private IEnumerable<DoctorModel> FilteredDoctors => string.IsNullOrWhiteSpace(doctorSearchText) 
        ? doctors 
        : doctors.Where(d => 
            d.FullName.Contains(doctorSearchText, StringComparison.OrdinalIgnoreCase) ||
            d.Specialization.Contains(doctorSearchText, StringComparison.OrdinalIgnoreCase));

    private DateTime? _selectedDate;
    private DateTime? selectedDate
    {
        get => _selectedDate;
        set
        {
            if (_selectedDate != value)
            {
                _selectedDate = value;
                _ = OnDateChangedAsync(value);
            }
        }
    }
    private TimeSlotModel? selectedTimeSlot;
    private string? appointmentReason;
    private string? appointmentNotes;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        await LoadInitialData();
    }
    
    private async Task LoadInitialData()
    {
        try
        {
            hasError = false;
            errorMessage = string.Empty;
            errorDetails = string.Empty;
            
            await LoadDoctors();
            await LoadMyAppointments();
            
            // Start counter animation after data is loaded
            if (!hasAnimated)
            {
                _ = AnimateCounters();
            }
            
            // Check if we got any data or if services might be down
            if (!doctors.Any() && !myAppointments.Any())
            {
                // This might indicate a silent failure - services returned empty but didn't throw
                Console.WriteLine("Warning: Both doctors and appointments lists are empty. Services may be unavailable.");
            }
        }
        catch (HttpRequestException ex)
        {
            hasError = true;
            errorMessage = "Unable to connect to the server. Please check if the backend service is running.";
            errorDetails = $"Network Error: {ex.Message}";
            Console.WriteLine($"HttpRequestException: {ex}");
        }
        catch (TaskCanceledException ex)
        {
            hasError = true;
            errorMessage = "The request timed out. The server might be slow or unreachable.";
            errorDetails = $"Timeout: {ex.Message}";
            Console.WriteLine($"TaskCanceledException: {ex}");
        }
        catch (Exception ex)
        {
            hasError = true;
            errorMessage = "An unexpected error occurred while loading your dashboard data.";
            errorDetails = $"{ex.GetType().Name}: {ex.Message}";
            Console.WriteLine($"Exception: {ex}");
        }
        finally
        {
            isLoadingDoctors = false;
            StateHasChanged();
        }
    }
    
    private async Task RetryLoading()
    {
        isRetrying = true;
        hasAnimated = false; // Reset animation on retry
        StateHasChanged();
        
        // Small delay for UX
        await Task.Delay(500);
        
        await LoadInitialData();
        
        isRetrying = false;
        StateHasChanged();
    }
    
    private async Task AnimateCounters()
    {
        hasAnimated = true;
        
        // Target values
        int targetUpcoming = myAppointments.Count(a => a.Status == AppointmentStatus.Scheduled);
        int targetCompleted = myAppointments.Count(a => a.Status == AppointmentStatus.Completed);
        int targetDoctors = doctors.Count;
        int targetTotalVisits = myAppointments.Count;
        
        // Animation duration and steps
        int animationDuration = 1000; // 1 second total
        int steps = 30; // Number of animation frames
        int stepDelay = animationDuration / steps;
        
        for (int i = 1; i <= steps; i++)
        {
            double progress = EaseOutQuad((double)i / steps);
            
            animatedUpcoming = (int)(targetUpcoming * progress);
            animatedCompleted = (int)(targetCompleted * progress);
            animatedDoctors = (int)(targetDoctors * progress);
            animatedTotalVisits = (int)(targetTotalVisits * progress);
            
            StateHasChanged();
            await Task.Delay(stepDelay);
        }
        
        // Ensure final values are exact
        animatedUpcoming = targetUpcoming;
        animatedCompleted = targetCompleted;
        animatedDoctors = targetDoctors;
        animatedTotalVisits = targetTotalVisits;
        StateHasChanged();
    }
    
    // Easing function for smooth animation (ease-out quad)
    private double EaseOutQuad(double t) => t * (2 - t);

    private async Task LoadDoctors()
    {
        isLoadingDoctors = true;
        doctors = await BookingService.GetDoctorsAsync();
        isLoadingDoctors = false;
    }

    private async Task OpenAddDoctorDialog()
    {
        var options = new DialogOptions 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<AddDoctorDialog>("Add New Doctor", options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is CreateDoctorRequest request)
        {
            var (success, message, doctor) = await BookingService.CreateDoctorAsync(request);
            
            if (success)
            {
                Snackbar.Add($"Dr. {request.FirstName} {request.LastName} has been added successfully!", Severity.Success);
                await LoadDoctors(); // Refresh the doctors list
            }
            else
            {
                Snackbar.Add(message, Severity.Error);
            }
        }
    }

    private async Task LoadMyAppointments()
    {
        myAppointments = await BookingService.GetMyAppointmentsAsync();
        appointmentCurrentPage = 1; // Reset to first page when appointments are reloaded
    }

    // Pagination methods
    private void GoToAppointmentPage(int page)
    {
        appointmentCurrentPage = page;
    }

    private void PreviousAppointmentPage()
    {
        if (appointmentCurrentPage > 1)
            appointmentCurrentPage--;
    }

    private void NextAppointmentPage()
    {
        if (appointmentCurrentPage < TotalAppointmentPages)
            appointmentCurrentPage++;
    }

    private void SelectDoctor(DoctorModel doctor)
    {
        selectedDoctor = doctor;
        _selectedDate = null;
        selectedTimeSlot = null;
        timeSlots.Clear();
    }

    private async Task StartNewAppointment()
    {
        // Reset all form fields for a fresh start
        activeStep = 0;
        selectedDoctor = null;
        _selectedDate = null;
        selectedTimeSlot = null;
        appointmentReason = null;
        appointmentNotes = null;
        doctorSearchText = string.Empty;
        timeSlots.Clear();
        
        // Scroll to the booking card
        await JSRuntime.InvokeVoidAsync("scrollToElement", "booking-card");
        
        StateHasChanged();
    }

    private async Task OnDateChangedAsync(DateTime? date)
    {
        selectedTimeSlot = null;
        
        if (date.HasValue && selectedDoctor != null)
        {
            await LoadTimeSlots();
            StateHasChanged();
        }
    }

    private async Task LoadTimeSlots()
    {
        if (selectedDoctor == null || !_selectedDate.HasValue)
            return;

        isLoadingTimeSlots = true;
        StateHasChanged();
        
        timeSlots = await BookingService.GetAvailableTimeSlotsAsync(selectedDoctor.Id, _selectedDate.Value);
        
        isLoadingTimeSlots = false;
        StateHasChanged();
    }

    private void SelectTimeSlot(TimeSlotModel slot)
    {
        selectedTimeSlot = slot;
    }

    private bool CanProceedToNextStep()
    {
        return activeStep switch
        {
            0 => selectedDoctor != null,
            1 => _selectedDate.HasValue && selectedTimeSlot != null,
            _ => true
        };
    }

    private bool CanBookAppointment()
    {
        return selectedDoctor != null && 
               _selectedDate.HasValue && 
               selectedTimeSlot != null;
    }

    private void NextStep()
    {
        if (CanProceedToNextStep() && activeStep < 2)
        {
            activeStep++;
        }
    }

    private void PreviousStep()
    {
        if (activeStep > 0)
        {
            activeStep--;
        }
    }

    private async Task BookAppointment()
    {
        if (!CanBookAppointment())
            return;

        isBooking = true;

        try
        {
            var request = new CreateAppointmentRequest
            {
                DoctorId = selectedDoctor!.Id,
                AppointmentDate = _selectedDate!.Value,
                AppointmentTime = selectedTimeSlot!.StartTime,
                DurationInMinutes = 30,
                Reason = appointmentReason,
                Notes = appointmentNotes
            };

            var (success, message, appointment) = await BookingService.BookAppointmentAsync(request);

            if (success)
            {
                Snackbar.Add(message, Severity.Success);
                
                activeStep = 0;
                selectedDoctor = null;
                _selectedDate = null;
                selectedTimeSlot = null;
                appointmentReason = null;
                appointmentNotes = null;
                timeSlots.Clear();

                await LoadMyAppointments();
            }
            else
            {
                Snackbar.Add(message, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"An error occurred: {ex.Message}", Severity.Error);
        }
        finally
        {
            isBooking = false;
        }
    }

    private async Task CancelAppointment(int appointmentId)
    {
        var parameters = new DialogParameters<ConfirmCancelDialog>
        {
            { x => x.ContentText, "Are you sure you want to cancel this appointment? This action cannot be undone." },
            { x => x.ButtonText, "Yes, Cancel" },
            { x => x.Color, Color.Error }
        };

        var options = new DialogOptions 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.ExtraSmall,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ConfirmCancelDialog>("Cancel Appointment", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            var (success, message) = await BookingService.CancelAppointmentAsync(appointmentId);
            
            if (success)
            {
                Snackbar.Add(message, Severity.Success);
                await LoadMyAppointments();
            }
            else
            {
                Snackbar.Add(message, Severity.Error);
            }
        }
    }

    private async Task CompleteAppointment(int appointmentId)
    {
        var parameters = new DialogParameters<ConfirmCancelDialog>
        {
            { x => x.ContentText, "Mark this appointment as completed?" },
            { x => x.ButtonText, "Yes, Complete" },
            { x => x.Color, Color.Success }
        };

        var options = new DialogOptions 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.ExtraSmall,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ConfirmCancelDialog>("Complete Appointment", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            var (success, message) = await BookingService.CompleteAppointmentAsync(appointmentId);
            
            if (success)
            {
                Snackbar.Add(message, Severity.Success);
                await LoadMyAppointments();
            }
            else
            {
                Snackbar.Add(message, Severity.Error);
            }
        }
    }

    private async Task RestoreAppointment(int appointmentId)
    {
        var parameters = new DialogParameters<ConfirmCancelDialog>
        {
            { x => x.ContentText, "Do you want to restore this cancelled appointment?" },
            { x => x.ButtonText, "Yes, Restore" },
            { x => x.Color, Color.Success }
        };

        var options = new DialogOptions 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.ExtraSmall,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ConfirmCancelDialog>("Restore Appointment", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            var (success, message) = await BookingService.RestoreAppointmentAsync(appointmentId);
            
            if (success)
            {
                Snackbar.Add(message, Severity.Success);
                await LoadMyAppointments();
            }
            else
            {
                Snackbar.Add(message, Severity.Error);
            }
        }
    }

    private async Task OnPatientSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(patientSearchText))
        {
            await SearchPatients();
        }
    }

    private async Task SearchPatients()
    {
        if (string.IsNullOrWhiteSpace(patientSearchText))
            return;

        isSearchingPatients = true;
        hasSearchedPatients = true;
        StateHasChanged();

        try
        {
            searchedPatients = await BookingService.SearchPatientsAsync(patientSearchText);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error searching patients: {ex.Message}", Severity.Error);
            searchedPatients = new();
        }
        finally
        {
            isSearchingPatients = false;
            StateHasChanged();
        }
    }
}
