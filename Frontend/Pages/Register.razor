@page "/register"
@layout AuthLayout
@using ClinicBookingSystem.Frontend.Services
@using ClinicBookingSystem.Frontend.Layout
@inject AuthService AuthService
@inject NavigationManager NavigationManager

<div style="min-height: 100vh; display: flex;">
    <!-- Left Side - Branding -->
    <div class="d-none d-md-flex" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: relative; overflow: hidden;">
        <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 30px 30px;"></div>
        <div style="position: relative; z-index: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 3rem; text-align: center; width: 100%;">
            <div style="background: rgba(255,255,255,0.15); border-radius: 24px; padding: 1.5rem; margin-bottom: 2rem; backdrop-filter: blur(10px);">
                <MudIcon Icon="@Icons.Material.Filled.LocalHospital" Style="font-size: 4rem; color: white;" />
            </div>
            <MudText Typo="Typo.h3" Style="color: white; font-weight: 700; margin-bottom: 1rem;">
                Join Us Today
            </MudText>
            <MudText Typo="Typo.h6" Style="color: rgba(255,255,255,0.9); font-weight: 400; max-width: 320px; line-height: 1.6;">
                Create your account and start booking appointments in minutes.
            </MudText>
            
            <div style="margin-top: 3rem;">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; text-align: left;">
                    <div style="background: rgba(255,255,255,0.2); border-radius: 50%; padding: 0.75rem;">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Style="color: white;" />
                    </div>
                    <MudText Style="color: white;">Free account registration</MudText>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; text-align: left;">
                    <div style="background: rgba(255,255,255,0.2); border-radius: 50%; padding: 0.75rem;">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Style="color: white;" />
                    </div>
                    <MudText Style="color: white;">Access to all doctors</MudText>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem; text-align: left;">
                    <div style="background: rgba(255,255,255,0.2); border-radius: 50%; padding: 0.75rem;">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Style="color: white;" />
                    </div>
                    <MudText Style="color: white;">24/7 appointment booking</MudText>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Side - Register Form -->
    <div style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 2rem; background: #fafafa; overflow-y: auto;">
        <div style="width: 100%; max-width: 480px;">
            <!-- Mobile Logo -->
            <div class="d-flex d-md-none justify-center mb-4">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 1rem;">
                    <MudIcon Icon="@Icons.Material.Filled.LocalHospital" Style="font-size: 2.5rem; color: white;" />
                </div>
            </div>

            <MudText Typo="Typo.h4" Style="font-weight: 700; color: #1a1a2e; margin-bottom: 0.5rem;">
                Create Account
            </MudText>
            <MudText Typo="Typo.body1" Style="color: #6b7280; margin-bottom: 2rem;">
                Fill in your details to get started
            </MudText>

            <EditForm Model="@registerModel" OnValidSubmit="HandleRegister">
                <DataAnnotationsValidator />

                <MudGrid Spacing="2">
                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.caption" Style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            First Name
                        </MudText>
                        <MudTextField @bind-Value="registerModel.FirstName"
                                      Placeholder="John"
                                      Variant="Variant.Outlined"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Person"
                                      Style="background: white;"
                                      Required="true"
                                      RequiredError="First name is required" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.caption" Style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Last Name
                        </MudText>
                        <MudTextField @bind-Value="registerModel.LastName"
                                      Placeholder="Doe"
                                      Variant="Variant.Outlined"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Person"
                                      Style="background: white;"
                                      Required="true"
                                      RequiredError="Last name is required" />
                    </MudItem>
                </MudGrid>

                <div style="margin-top: 1.25rem;">
                    <MudText Typo="Typo.caption" Style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                        Email Address
                    </MudText>
                    <MudTextField @bind-Value="registerModel.Email"
                                  Placeholder="john.doe@example.com"
                                  Variant="Variant.Outlined"
                                  InputType="InputType.Email"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Email"
                                  Style="background: white;"
                                  Required="true"
                                  RequiredError="Email is required" />
                </div>

                <div style="margin-top: 1.25rem;">
                    <MudText Typo="Typo.caption" Style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                        Phone Number <span style="color: #9ca3af; font-weight: 400;">(Optional)</span>
                    </MudText>
                    <MudTextField @bind-Value="registerModel.PhoneNumber"
                                  Placeholder="+1 (555) 000-0000"
                                  Variant="Variant.Outlined"
                                  InputType="InputType.Telephone"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Phone"
                                  Style="background: white;" />
                </div>

                <MudGrid Spacing="2" Class="mt-3">
                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.caption" Style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Password
                        </MudText>
                        <MudTextField @bind-Value="registerModel.Password"
                                      Placeholder="Min. 6 characters"
                                      Variant="Variant.Outlined"
                                      InputType="@passwordInputType"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@passwordIcon"
                                      OnAdornmentClick="TogglePasswordVisibility"
                                      Style="background: white;"
                                      Required="true"
                                      RequiredError="Password is required" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.caption" Style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Confirm Password
                        </MudText>
                        <MudTextField @bind-Value="registerModel.ConfirmPassword"
                                      Placeholder="Confirm password"
                                      Variant="Variant.Outlined"
                                      InputType="@confirmPasswordInputType"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@confirmPasswordIcon"
                                      OnAdornmentClick="ToggleConfirmPasswordVisibility"
                                      Style="background: white;"
                                      Required="true"
                                      RequiredError="Please confirm your password" />
                    </MudItem>
                </MudGrid>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Class="mt-4" Variant="Variant.Filled" Dense="true">
                        @errorMessage
                    </MudAlert>
                }

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <MudAlert Severity="Severity.Success" Class="mt-4" Variant="Variant.Filled" Dense="true">
                        @successMessage
                    </MudAlert>
                }

                <MudButton ButtonType="ButtonType.Submit"
                           Variant="Variant.Filled"
                           FullWidth="true"
                           Size="Size.Large"
                           Class="mt-4"
                           Disabled="@isLoading"
                           Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 52px; font-weight: 600; font-size: 1rem; text-transform: none; border-radius: 8px;">
                    @if (isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" Style="color: white;" />
                        <span>Creating account...</span>
                    }
                    else
                    {
                        <span>Create Account</span>
                    }
                </MudButton>
            </EditForm>

            <div style="margin-top: 1.5rem; text-align: center;">
                <MudText Style="color: #6b7280;">
                    Already have an account? 
                    <MudLink Href="/login" Style="color: #667eea; font-weight: 600;">Sign in</MudLink>
                </MudText>
            </div>

            <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb; text-align: center;">
                <MudText Typo="Typo.caption" Style="color: #9ca3af;">
                    Â© 2025 Clinic Booking System. All rights reserved.
                </MudText>
            </div>
        </div>
    </div>
</div>

@code {
    private RegisterModel registerModel = new();
    private bool isLoading = false;
    private string? errorMessage;
    private string? successMessage;
    
    private bool showPassword = false;
    private InputType passwordInputType = InputType.Password;
    private string passwordIcon = Icons.Material.Filled.VisibilityOff;
    
    private bool showConfirmPassword = false;
    private InputType confirmPasswordInputType = InputType.Password;
    private string confirmPasswordIcon = Icons.Material.Filled.VisibilityOff;

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
        passwordInputType = showPassword ? InputType.Text : InputType.Password;
        passwordIcon = showPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    }

    private void ToggleConfirmPasswordVisibility()
    {
        showConfirmPassword = !showConfirmPassword;
        confirmPasswordInputType = showConfirmPassword ? InputType.Text : InputType.Password;
        confirmPasswordIcon = showConfirmPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    }

    private async Task HandleRegister()
    {
        isLoading = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            // Validate passwords match
            if (registerModel.Password != registerModel.ConfirmPassword)
            {
                errorMessage = "Passwords do not match.";
                return;
            }

            // Validate password length
            if (registerModel.Password.Length < 6)
            {
                errorMessage = "Password must be at least 6 characters.";
                return;
            }

            var (success, message) = await AuthService.RegisterAsync(
                registerModel.Email,
                registerModel.Password,
                registerModel.FirstName,
                registerModel.LastName,
                registerModel.PhoneNumber
            );

            if (success)
            {
                successMessage = "Account created successfully! Redirecting to dashboard...";
                await Task.Delay(1000);
                NavigationManager.NavigateTo("/");
            }
            else
            {
                errorMessage = message ?? "Registration failed. Email may already be in use.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private class RegisterModel
    {
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string? PhoneNumber { get; set; }
        public string Password { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
