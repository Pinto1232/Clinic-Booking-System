@page "/login"
@layout AuthLayout
@using ClinicBookingSystem.Frontend.Services
@using ClinicBookingSystem.Frontend.Layout
@inject AuthService AuthService
@inject NavigationManager NavigationManager

<div style="min-height: 100vh; display: flex;">
    <!-- Left Side - Branding -->
    <div class="d-none d-md-flex" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: relative; overflow: hidden;">
        <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 30px 30px;"></div>
        <div style="position: relative; z-index: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 3rem; text-align: center; width: 100%;">
            <div style="background: rgba(255,255,255,0.15); border-radius: 24px; padding: 1.5rem; margin-bottom: 2rem; backdrop-filter: blur(10px);">
                <MudIcon Icon="@Icons.Material.Filled.LocalHospital" Style="font-size: 4rem; color: white;" />
            </div>
            <MudText Typo="Typo.h3" Style="color: white; font-weight: 700; margin-bottom: 1rem;">
                Clinic Booking
            </MudText>
            <MudText Typo="Typo.h6" Style="color: rgba(255,255,255,0.9); font-weight: 400; max-width: 320px; line-height: 1.6;">
                Your health, our priority. Book appointments with ease.
            </MudText>
            
            <div style="margin-top: 3rem; display: flex; gap: 2rem;">
                <div style="text-align: center;">
                    <MudIcon Icon="@Icons.Material.Filled.Schedule" Style="font-size: 2rem; color: rgba(255,255,255,0.9);" />
                    <MudText Style="color: rgba(255,255,255,0.8); font-size: 0.85rem; margin-top: 0.5rem;">Easy Booking</MudText>
                </div>
                <div style="text-align: center;">
                    <MudIcon Icon="@Icons.Material.Filled.MedicalServices" Style="font-size: 2rem; color: rgba(255,255,255,0.9);" />
                    <MudText Style="color: rgba(255,255,255,0.8); font-size: 0.85rem; margin-top: 0.5rem;">Expert Doctors</MudText>
                </div>
                <div style="text-align: center;">
                    <MudIcon Icon="@Icons.Material.Filled.Security" Style="font-size: 2rem; color: rgba(255,255,255,0.9);" />
                    <MudText Style="color: rgba(255,255,255,0.8); font-size: 0.85rem; margin-top: 0.5rem;">Secure & Safe</MudText>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Side - Login Form -->
    <div style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 2rem; background: #fafafa;">
        <div style="width: 100%; max-width: 420px;">
            <!-- Mobile Logo -->
            <div class="d-flex d-md-none justify-center mb-6">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 1rem;">
                    <MudIcon Icon="@Icons.Material.Filled.LocalHospital" Style="font-size: 2.5rem; color: white;" />
                </div>
            </div>

            <MudText Typo="Typo.h4" Style="font-weight: 700; color: #1a1a2e; margin-bottom: 0.5rem;">
                Welcome Back
            </MudText>
            <MudText Typo="Typo.body1" Style="color: #6b7280; margin-bottom: 2rem;">
                Sign in to access your appointments
            </MudText>

            <EditForm Model="@loginModel" OnValidSubmit="HandleLogin">
                <DataAnnotationsValidator />
                
                <div style="margin-bottom: 1.5rem;">
                    <MudText Typo="Typo.caption" Style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                        Email Address
                    </MudText>
                    <MudTextField @bind-Value="loginModel.Email"
                                  Placeholder="Enter your email"
                                  Variant="Variant.Outlined"
                                  InputType="InputType.Email"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Email"
                                  Style="background: white;"
                                  Required="true"
                                  RequiredError="Email is required" />
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <MudText Typo="Typo.caption" Style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                        Password
                    </MudText>
                    <MudTextField @bind-Value="loginModel.Password"
                                  Placeholder="Enter your password"
                                  Variant="Variant.Outlined"
                                  InputType="@passwordInputType"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@passwordIcon"
                                  OnAdornmentClick="TogglePasswordVisibility"
                                  Style="background: white;"
                                  Required="true"
                                  RequiredError="Password is required" />
                </div>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Class="mb-4" Variant="Variant.Filled" Dense="true">
                        @errorMessage
                    </MudAlert>
                }

                <MudButton ButtonType="ButtonType.Submit"
                           Variant="Variant.Filled"
                           FullWidth="true"
                           Size="Size.Large"
                           Disabled="@isLoading"
                           Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 52px; font-weight: 600; font-size: 1rem; text-transform: none; border-radius: 8px;">
                    @if (isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" Style="color: white;" />
                        <span>Signing in...</span>
                    }
                    else
                    {
                        <span>Sign In</span>
                    }
                </MudButton>
            </EditForm>

            <div style="margin-top: 2rem; text-align: center;">
                <MudText Style="color: #6b7280;">
                    Don't have an account? 
                    <MudLink Href="/register" Style="color: #667eea; font-weight: 600;">Create one</MudLink>
                </MudText>
            </div>

            <div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #e5e7eb; text-align: center;">
                <MudText Typo="Typo.caption" Style="color: #9ca3af;">
                    Â© 2025 Clinic Booking System. All rights reserved.
                </MudText>
            </div>
        </div>
    </div>
</div>

@code {
    private LoginModel loginModel = new();
    private bool isLoading = false;
    private string? errorMessage;
    private bool showPassword = false;
    private InputType passwordInputType = InputType.Password;
    private string passwordIcon = Icons.Material.Filled.VisibilityOff;

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
        passwordInputType = showPassword ? InputType.Text : InputType.Password;
        passwordIcon = showPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    }

    private async Task HandleLogin()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var (success, message) = await AuthService.LoginAsync(loginModel.Email, loginModel.Password);
            if (success)
            {
                NavigationManager.NavigateTo("/");
            }
            else
            {
                errorMessage = message ?? "Invalid email or password. Please try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private class LoginModel
    {
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }
}
